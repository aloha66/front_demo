<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
      .drag {
        width: 400px;
        background: #ddd;
        text-align: center;
        line-height: 200px;
      }

      .textarea {
        display: block;
        height: 200px;
        border: 1px dashed #aaa;
      }
    </style>
  </head>

  <body>
    <div>
      <h2>普通上传</h2>
      <input
        type="file"
        multiple
        name="file"
        id="commonUpload"
        onchange="commomUpload()"
      />
    </div>
    <div>
      <h2>拖拽上传</h2>
      <div id="drag" class="drag">
        拖拽上传
      </div>
    </div>
    <div>
      <h2>粘贴上传</h2>
      <div
        contenteditable
        spellcheck="false"
        id="textarea"
        class="textarea"
      ></div>
    </div>
  </body>
</html>
<script>
  function isImageFileType({ type }) {
    return type.includes("image/");
  }

  function fileToUrl(file, isBlob) {
    if (isBlob) {
      // 记得要释放对象
      return URL.createObjectURL(file);
    } else {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      return new Promise(reslove => {
        reader.onload = function() {
          reslove(reader.result);
        };
      });
    }
  }

  async function previewImg(files, isBlob) {
    for (let file of files) {
      // 判断是否是图片类型，是执行预览
      if (isImageFileType(file)) {
        file.thumbUrl = await fileToUrl(file, isBlob);
      }
    }
    return files;
  }

  async function showImgs(files, isBlob = true) {
    const imgs = await previewImg(files, isBlob);
    for (let file of imgs) {
      const div = document.createElement("div");
      const img = new Image();
      img.src = file.thumbUrl;
      if (isBlob) {
        img.onload = function(e) {
          // 释放createObjectURL创建的对象
          URL.revokeObjectURL(file.thumbUrl);
        };
      }
      div.appendChild(img);
      document.body.appendChild(div);
    }
  }

  async function upload(files) {
    showImgs(files);
    let formData = new FormData();
    formData.append("files", files);
    axios({
      method: "post",
      url: "/upload",
      data: formData
    })
      .then(res => {})
      .catch(e => e);
  }

  function commomUpload() {
    const files = document.querySelector("#commonUpload").files;
    upload(files);
  }

  // 拖拽上传
  const drag = document.querySelector("#drag");
  drag.addEventListener("dragover", function(e) {
    e.preventDefault();
  });
  drag.addEventListener("drop", function(e) {
    e.preventDefault();
    // 没有文件上传
    if (!e.dataTransfer.files.length) return;
    const files = e.dataTransfer.files;
    upload(files);
  });

  // 粘贴上传
  const textarea = document.querySelector("#textarea");
  textarea.addEventListener("paste", function(e) {
    const items = e.clipboardData.items;
    let arr = [];
    for (let i = 0, len = items.length; i < len; i++) {
      if (items[i].kind === "string" && items[i].type === "text/plain") {
        items[i].getAsString(function(str) {
          arr.push(str);
        });
      } else if (items[i].kind === "file") {
        const file = e.clipboardData.files[0];
        upload(files);
      }
    }
    // debugger
  });
</script>
